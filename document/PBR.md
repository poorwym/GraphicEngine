# PBR

在**物理基础渲染（Physically Based Rendering，简称PBR**模型中，为了实现高度逼真的材质效果，您需要提供多种数据和纹理贴图。这些数据和贴图共同描述了材质的物理属性，确保光照计算更加真实和一致。以下是PBR模型所需的主要数据和贴图，以及它们的具体作用和实现方式。

## 1. 必需的数据和贴图

### a. 基础颜色贴图（Base Color / Albedo Map）
- **作用**：表示材质的固有颜色，不包含任何光照信息。它定义了物体在无光照情况下的颜色。
- **特点**：
  - 对于非金属材料，基础颜色贴图反映了物体的真实颜色。
  - 对于金属材料，基础颜色贴图通常反映了金属的颜色，因为金属表面会反射环境色彩。

### b. 金属度贴图（Metallic Map）
- **作用**：定义材质表面哪些部分是金属，哪些部分是非金属。
- **特点**：
  - 值范围通常在0（非金属）到1（金属）之间。
  - 金属部分通常没有漫反射，仅有镜面反射。
  - 非金属部分具有漫反射和镜面反射。
- **实现方式**：可以使用灰度图，其中白色（255）代表金属，黑色（0）代表非金属。

### c. 粗糙度贴图（Roughness Map）
- **作用**：描述材质表面的粗糙程度，影响镜面反射的扩散程度。
- **特点**：
  - 值范围通常在0（光滑）到1（非常粗糙）之间。
  - 低粗糙度值导致高光集中且锐利，高粗糙度值导致高光扩散且模糊。
- **实现方式**：使用灰度图，其中白色（255）代表最高粗糙度，黑色（0）代表最低粗糙度。

### d. 法线贴图（Normal Map）
- **作用**：通过扰动表面法线向量，模拟细微的表面凹凸和细节，增强材质的细节表现。
- **特点**：
  - 使用RGB颜色值来表示法线的XYZ分量。
  - 通常在着色器中将颜色值转换为法线向量，例如：`normal = normalize(normalMapColor * 2.0 - 1.0)`。
- **实现方式**：使用专门的法线贴图工具生成，通常为蓝绿色调。

### e. 环境光遮蔽贴图（Ambient Occlusion Map）
- **作用**：模拟环境光在材质表面不同区域的遮蔽效果，增强深度感和真实感。
- **特点**：
  - 灰度图，白色（255）表示完全暴露，黑色（0）表示完全遮蔽。
  - 通常与基础颜色贴图结合使用，乘以基础颜色以调整整体亮度。
- **实现方式**：可以通过烘焙或生成工具创建。

### f. 自发光贴图（Emissive Map）（可选）
- **作用**：定义材质表面哪些部分会自发光，即在不受外部光照影响下发出光亮。
- **特点**：
  - RGB颜色图，表示自发光的颜色和强度。
  - 常用于模拟灯光、屏幕显示等发光效果。
- **实现方式**：使用RGB图，其中亮色区域表示发光区域。

### g. 高度贴图（Height Map）（可选）
- **作用**：用于视差映射（Parallax Mapping）或置换映射（Displacement Mapping），通过修改顶点位置或纹理坐标，增加表面深度感。
- **特点**：
  - 灰度图，表示表面高度信息。
- **实现方式**：使用专门的高度贴图生成工具创建。

## 2. 其他必要的数据

### a. 观察者位置（View Position）
- **作用**：用于计算镜面反射部分，影响高光的方向和强度。
- **实现方式**：在渲染循环中将摄像机或观察者的位置传递给着色器。

### b. 光源信息
- **作用**：定义场景中所有光源的属性，如位置、颜色、强度等。
- **特点**：
  - 包括方向光、点光源、聚光灯等多种光源类型。
- **实现方式**：在C++代码中定义光源结构体，并将其属性传递给着色器。

## 3. PBR渲染流程概述

1. **采样纹理**：
   - 从基础颜色贴图、金属度贴图、粗糙度贴图、法线贴图、环境光遮蔽贴图等获取材质属性数据。

2. **法线处理**：
   - 使用法线贴图调整表面法线，增加细节和凹凸感。

3. **光照计算**：
   - 对每个光源（方向光、点光源等），计算其对漫反射和镜面反射的贡献。
   - 使用Cook-Torrance模型，结合法线分布函数（NDF）、菲涅耳项和几何遮挡函数进行光照计算。
   - 对于点光源，考虑光源与物体之间的距离衰减。

4. **环境光照**：
   - 结合环境光遮蔽贴图，模拟全局光照效果，增强深度感。

5. **累加光照贡献**：
   - 将所有光源的光照贡献累加，得到最终的光照值。

6. **材质混合**：
   - 根据金属度和粗糙度属性，混合漫反射和镜面反射，调整最终颜色。

7. **输出颜色**：
   - 将计算得到的颜色输出为片元颜色，渲染到屏幕上。

## 4. PBR模型中的关键参数

### a. 金属度（Metallic）
- **范围**：0（非金属）到1（金属）。
- **影响**：
  - 非金属材料具有漫反射和镜面反射，镜面反射率通常为0.04。
  - 金属材料仅具有镜面反射，镜面反射率由金属颜色决定，漫反射部分为0。

### b. 粗糙度（Roughness）
- **范围**：0（光滑）到1（非常粗糙）。
- **影响**：
  - 低粗糙度值导致高光集中且锐利，高粗糙度值导致高光扩散且模糊。

### c. 法线（Normal）
- **作用**：提供表面微细结构和凹凸感，通过法线贴图实现。

### d. 环境光遮蔽（Ambient Occlusion）
- **作用**：增强物体表面细节，模拟环境光在凹陷区域的遮蔽效果。

## 5. PBR模型的优势

- **真实感高**：基于物理定律，光照和材质反应更加接近现实。
- **一致性好**：材质在不同光照条件下表现一致，减少了调整复杂性。
- **易于管理**：通过统一的材质属性（如金属度和粗糙度）简化了材质管理和共享。
- **扩展性强**：支持多种光照类型和复杂的材质效果，如金属、非金属、透明材质等。

## 6. 实现PBR模型的注意事项

### a. 纹理格式和精度
- **建议**：使用高精度的纹理格式（如HDR）以确保材质属性的准确性。
- **注意**：避免在同一贴图中存储不同属性，保持每个贴图的单一用途。

### b. 法线贴图的正确处理
- **确保**：法线贴图的RGB值经过正确的转换，以生成准确的法线向量。
- **建议**：使用规范化的法线向量，避免因未规范化导致光照计算错误。

### c. 光照模型的优化
- **建议**：合理控制光源数量，避免过多光源导致性能下降。
- **优化**：使用统一缓冲对象（UBO）或其他高效的数据传输方式管理光源数据。

### d. 材质属性的合理配置
- **建议**：根据实际需求合理设置金属度和粗糙度值，确保材质表现符合预期。
- **调试**：通过实时调整材质属性观察效果，确保光照计算正确。

## 7. 总结

物理基础渲染（PBR）模型通过精确模拟光与材质的相互作用，显著提升了渲染的真实感和一致性。实现PBR模型需要提供多种材质属性和纹理贴图，如基础颜色贴图、金属度贴图、粗糙度贴图、法线贴图和环境光遮蔽贴图等。这些数据和贴图共同描述了材质的物理特性，使得光照计算更加逼真和自然。

在实际开发中，合理配置和管理这些材质属性，结合高效的光照计算方法，可以实现高质量的3D渲染效果。通过理解PBR的核心概念和数学基础，您可以在OpenGL项目中构建出更加真实和复杂的材质效果，提升整体视觉表现力。